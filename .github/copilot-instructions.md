# Copilot / AI agent instructions for PDF Page Analyzer (PDF_Список листов)

Кратко и по делу — информация, которая помогает быстро начать вносить правки и генерировать PR в этом репозитории.

## Коротко — что это
- Программа для анализа PDF (определение форматов, размеров, цветности, отчёты в Excel и текстовом виде).
- Основной скрипт: `pdfpages_pro.py` (GUI + CLI entry point).

## Большая картина (архитектура)
- PDFAnalyzer (в `pdfpages_pro.py`) — ядро: анализ страниц, сопоставление со справочными форматами, формирование DataFrame и Excel-отчёта.
- MainWindow (Tkinter) — GUI-оболочка, отображение текстового отчёта, интерфейс для открытия файла/папки и редактирования конфигурации.
- ConfigEditor (`config_editor.py`) — редактор `config.yaml` с валидацией и автосохранением.
- Выходы: `{base_name}_all_sizes.xlsx` и `{base_name}_report.txt` (автосохранение после анализа).

## Как запускать (работочая команда примеры)
- Установить зависимости:
  pip install -r requirements.txt
- GUI (обычно):
  python pdfpages_pro.py
- CLI (анализ файла/папки + показ результата в GUI):
  python pdfpages_pro.py "C:\PDFs"  
  (Примечание: CLI не работает headless — окно всё равно откроется с результатом.)

## Конфигурация (`config.yaml`) — важное
- Параметры:
  - `tolerance_mm` — допуск в мм (валидируется в редакторе: 0.1–50.0 мм).
  - `compress_ranges` — флаг, сжатие последовательных номеров страниц.
  - `formats` — словарь форматов `{"A4": [210, 297], ...}`. Обратите внимание: проект использует символ '×' в именах (например, `A4×3`). Меняйте ключи аккуратно — код опирается на совпадение строк.
- Где ищется конфиг (в порядке приоритета): `config.yaml` (текущая папка), `./config.yaml` рядом со скриптом, `cwd/config.yaml`, `~/config.yaml`. Если не найден — будет создан `config.yaml` в текущей папке.

## Важные особенности кода и паттерны
- `resource_path(relative_path)` (в `MainWindow`) учитывает PyInstaller (`sys._MEIPASS`) — когда пакуем в EXE, добавляйте ресурсы в `--add-data`.
- Генерация Excel: используется `pandas` + `openpyxl` (лист `Все страницы` и `Сводка ЕСКД`). Структура DataFrame показана в `README.md`.
- Анализ цветности (`analyze_page_color`) — сначала проверяет изображения (get_images + Pixmap), затем векторные рисунки (stroke/fill). Это не универсальный цветовой анализ (может не находить все цветные случаи).
- Формирование текстового отчёта и сжатие диапазонов происходит в `build_report_text`.

## Сборка / упаковка
- Пример команды в README для создания EXE (PyInstaller):
  pyinstaller --onefile --windowed ^
    --add-data "logo.png;." ^
    --add-data "config.yaml;." ^
    --icon "logo.ico" ^
    --name "PDF_Analyzer" ^
    pdfpages_pro.py
- Необходимо включать `config.yaml` и любые иконки/лого в `--add-data` — иначе GUI может не найти ресурсы в режиме EXE.

## Зависимости и среда
- См. `requirements.txt` (версии зафиксированы). Основные: PyMuPDF, pandas, openpyxl, PyYAML.
- При редактировании GUI/изображений может понадобиться Pillow.

## Частые проблемы / полезные подсказки
- PermissionError при записи Excel — часто файл открыт в Excel. Закрыть Excel, повторить.
- Отсутствие `logo.png` не критично — код подставляет текстовый fallback.
- При изменении форматов соблюдайте синтаксическую форму ключей (символ '×' и целочисленные мм).
- Нет headless-режима: вызов с аргументом сохраняет файлы и открывает GUI.

## Тесты и где их добавить
- В репозитории тестов нет. Для ускорения изменений полезно добавить unit tests для:
  - `PDFAnalyzer.get_standard_format`
  - `PDFAnalyzer.analyze_page_color` (частично, через мок Page/Images)
  - `PDFAnalyzer.process_path` и `process_pdf` (на малых тестовых PDF)
- Место для новых тестов: создать `tests/test_pdf_analyzer.py`.

## Файлы, которые стоит просматривать при изменениях
- `pdfpages_pro.py` — главный файл, логика анализа и UI
- `config_editor.py` — валидация, поиск и сохранение `config.yaml`
- `config.yaml` — значения по умолчанию
- `requirements.txt` — зафиксированные зависимости
- `README.md` — примеры запуска и заметки для пользователей
- `pdfpages_pro.spec` — pyinstaller-спецификация

---
Если нужно — могу сузить инструкцию под конкретную задачу (написание тестов, рефакторинг анализа цвета или упрощение CLI до headless-режима). Напишите, какие части вы хотите прояснить или дополнить. ✅
